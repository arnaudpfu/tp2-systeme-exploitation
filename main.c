#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/wait.h>

// Question 1
void create_chain_of_processes(int n)
{
    if (n <= 0)
    {
        return;
    }

    pid_t pid = fork();

    if (pid < 0)
    {
        fprintf(stderr, "Failed to create child process\n");
        exit(EXIT_FAILURE);
    }
    else if (pid == 0)
    {
        // Child process
        printf("Child process %d with parent %d\n", getpid(), getppid());
        create_chain_of_processes(n - 1);
        exit(EXIT_SUCCESS);
    }
    else
    {
        // Parent process
        wait(NULL);
    }
    sleep(20);
}

// Question 2
void create_binary_tree(int level, int max_level)
{
    pid_t pid_left, pid_right;

    if (level == max_level)
    {
        sleep(200);
        return;
    }

    pid_left = fork();
    if (pid_left == -1)
    {
        perror("fork");
        exit(1);
    }
    else if (pid_left == 0)
    {
        printf("Child (PID=%d, PPID=%d) created (left)\n", getpid(), getppid());
        create_binary_tree(level + 1, max_level);
        exit(0);
    }

    pid_right = fork();
    if (pid_right == -1)
    {
        perror("fork");
        exit(1);
    }
    else if (pid_right == 0)
    {
        printf("Child (PID=%d, PPID=%d) created (right)\n", getpid(), getppid());
        create_binary_tree(level + 1, max_level);
        exit(0);
    }

    waitpid(pid_left, NULL, 0);
    waitpid(pid_right, NULL, 0);
}

// Question 3
void create_zombie()
{
    pid_t z_pid = fork();

    if (z_pid == -1)
    {
        perror("fork");
        exit(1);
    }
    else if (z_pid == 0)
    {
        // child
        printf("Child (PID=%d, PPID=%d)\n", getpid(), getppid());
        exit(0);
    }
    else
    {
        // parent
        printf("Parent pid %d\n", z_pid);
        sleep(1000);
        wait(NULL);
    }
}
/*
This is what I get in the console by taping `ps -l`:
  UID   PID  PPID        F CPU PRI NI       SZ    RSS WCHAN     S             ADDR TTY           TIME CMD
  501 31447   866     4006   0  31  0 408169440   3280 -      Ss                  0 ttys000    0:00.06 /bin/zsh -il
  501 33671 31447     4006   0  31  0 407971408    896 -      S+                  0 ttys000    0:00.00 ./exec 10
  501 33672 33671     2006   0   0  0        0      0 -      Z+                  0 ttys000    0:00.00 <defunct>
  501 27185   866     4006   0  31  0 408291296   3248 -      Ss                  0 ttys006    0:00.05 /bin/zsh -il

  We can see that the process 33672 (that have been created) doesn't use ressources => it is a zombie as say (S = Z+)
 */

// Question 4
void print_return_value()
{
    pid_t pid = fork();

    if (pid == -1)
    {
        perror("fork");
        exit(1);
    }
    else if (pid == 0)
    {
        // child
        printf("Child (PID=%d, PPID=%d)\n", getpid(), getppid());
        int value;
        printf("Enter an integer: ");
        scanf("%d", &value);
        exit(value);
    }
    else
    {
        // parent
        printf("Parent pid %d\n", pid);
        int return_value;
        wait(&return_value);
        printf("The child process returned the value : %d\n", WEXITSTATUS(return_value));
    }
}

int main(int argc, char *argv[])
{
    if (argc != 2)
    {
        fprintf(stderr, "Usage: %s <n>\n", argv[0]);
        return EXIT_FAILURE;
    }
    int n = atoi(argv[1]);
    // Question 1
    // create_chain_of_processes(n);

    // Question 2
    // create_binary_tree(0, n);

    // Question 3
    // create_zombie();

    // Question 4
    print_return_value();

    return EXIT_SUCCESS;
}
